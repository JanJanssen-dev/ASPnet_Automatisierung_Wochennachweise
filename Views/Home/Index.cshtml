@model UmschulungConfig
@{
    ViewData["Title"] = "Wochennachweis-Generator";
    var debugEnabled = Context.RequestServices.GetRequiredService<Microsoft.Extensions.Options.IOptions<DebugOptions>>().Value.EnableDebug;
}

<div class="container">
    <!-- DELETE-FORMS für Kompatibilität -->
    @for (int i = 0; i < Model.Zeitraeume.Count; i++)
    {
        <form action="/Home/DeleteZeitraum" method="post" class="delete-zeitraum-form" id="delete-form-@i" style="display: none;">
            <input type="hidden" name="index" value="@i" />
        </form>
    }

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <h1 class="my-4 text-center">
                <i class="bi bi-file-earmark-word text-primary me-2"></i>
                Wochennachweis-Generator
                @if (debugEnabled)
                {
                    <small class="badge bg-warning text-dark ms-2">🔧 DEBUG</small>
                }
            </h1>
            <p class="text-center text-muted mb-4">
                Automatische Erstellung von Wochennachweisen für Umschulung und Praktikum
                <br><small><i class="bi bi-cpu me-1"></i>Alle Daten bleiben in Ihrem Browser - keine Server-Übertragung</small>
            </p>

            @if (TempData["StatusMessage"] != null)
            {
                <div class="alert alert-@(TempData["StatusMessageType"] ?? "success") alert-dismissible fade show" role="alert">
                    <i class="bi bi-@(TempData["StatusMessageType"]?.ToString() == "danger" ? "exclamation-triangle" : "check-circle") me-2"></i>@TempData["StatusMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- HAUPTFORMULAR -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>Grunddaten
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="resetAll()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Alles zurücksetzen
                    </button>
                </div>
                <div class="card-body">
                    <form action="/Home/Generate" method="post" id="wochennachweis-form">
                        <div class="row">
                            <div class="col-lg-3 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Umschulungsbeginn" class="form-label">
                                        <i class="bi bi-calendar-event me-1"></i>Beginn der Umschulung *
                                    </label>
                                    <input asp-for="Umschulungsbeginn" class="form-control" type="date" required id="Umschulungsbeginn" />
                                    <span asp-validation-for="Umschulungsbeginn" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="UmschulungsEnde" class="form-label">
                                        <i class="bi bi-calendar-x me-1"></i>Ende der Umschulung *
                                    </label>
                                    <input asp-for="UmschulungsEnde" class="form-control" type="date" required id="UmschulungsEnde" />
                                    <span asp-validation-for="UmschulungsEnde" class="text-danger"></span>
                                    <div class="form-text">Fallback falls keine Zeiträume definiert</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Nachname" class="form-label">
                                        <i class="bi bi-person me-1"></i>Nachname *
                                    </label>
                                    <input asp-for="Nachname" class="form-control" required id="Nachname" />
                                    <span asp-validation-for="Nachname" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Vorname" class="form-label">
                                        <i class="bi bi-person me-1"></i>Vorname *
                                    </label>
                                    <input asp-for="Vorname" class="form-control" required id="Vorname" />
                                    <span asp-validation-for="Vorname" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-4 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Klasse" class="form-label">
                                        <i class="bi bi-mortarboard me-1"></i>Klasse/Kurs *
                                    </label>
                                    <input asp-for="Klasse" class="form-control" required id="Klasse" placeholder="z.B. FIAE-2023-A" />
                                    <span asp-validation-for="Klasse" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Bundesland" class="form-label">
                                        <i class="bi bi-geo-alt me-1"></i>Bundesland (für Feiertage) *
                                    </label>
                                    <select asp-for="Bundesland" class="form-select" required id="Bundesland">
                                        @foreach (var bundesland in UmschulungConfig.BundeslaenderListe)
                                        {
                                            <option value="@bundesland.Key" selected="@(Model.Bundesland == bundesland.Key)">
                                                @bundesland.Value
                                            </option>
                                        }
                                    </select>
                                    <span asp-validation-for="Bundesland" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-pen me-1"></i>Signatur (optional)
                                    </label>
                                    <input type="file" class="form-control" id="signatur-upload" accept="image/jpeg,image/jpg,image/png" />
                                    <div class="form-text">JPG/PNG, max. 2MB</div>
                                    @if (!string.IsNullOrEmpty(Model.SignaturDateiname))
                                    {
                                        <small class="text-success">✅ @Model.SignaturDateiname</small>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- INLINE ZEITRÄUME-EINGABE -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar3 me-2"></i>Zeiträume definieren
                                    <span class="badge bg-secondary" id="zeitraeume-count">@Model.Zeitraeume.Count</span>
                                </h5>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>Pro Tag nur ein Zeitraum möglich
                                </small>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="zeitraeume-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="15%">Kategorie</th>
                                                <th width="20%">Von</th>
                                                <th width="20%">Bis</th>
                                                <th width="35%">Beschreibung</th>
                                                <th width="10%">Aktion</th>
                                            </tr>
                                        </thead>
                                        <tbody id="zeitraeume-tbody">
                                            <!-- Bestehende Zeiträume -->
                                            @for (int i = 0; i < Model.Zeitraeume.Count; i++)
                                            {
                                                <tr data-index="@i">
                                                    <td>
                                                        <span class="badge @(Model.Zeitraeume[i].KategorieBadgeClass)">
                                                            @Model.Zeitraeume[i].Kategorie
                                                        </span>
                                                    </td>
                                                    <td>@Model.Zeitraeume[i].Start.ToString("dd.MM.yyyy")</td>
                                                    <td>@Model.Zeitraeume[i].Ende.ToString("dd.MM.yyyy")</td>
                                                    <td>@Model.Zeitraeume[i].Beschreibung</td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm"
                                                                onclick="deleteZeitraum(@i)" title="Zeitraum löschen">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }

                                            <!-- Neue Eingabe-Zeile -->
                                            <tr id="neue-eingabe-zeile" class="table-info">
                                                <td>
                                                    <select class="form-select form-select-sm" id="neue-kategorie" required>
                                                        <option value="">Wählen...</option>
                                                        <option value="Umschulung">Umschulung</option>
                                                        <option value="Praktikum">Praktikum</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="date" class="form-control form-control-sm" id="neues-start" required />
                                                </td>
                                                <td>
                                                    <input type="date" class="form-control form-control-sm" id="neues-ende" required />
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="neue-beschreibung"
                                                           placeholder="z.B. Modul HTML/CSS" required maxlength="500" />
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-success btn-sm" id="hinzufuegen-btn"
                                                            onclick="addZeitraumInline()" title="Zeitraum hinzufügen">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Überschneidungs-Warnung -->
                                <div id="ueberschneidungs-warnung" class="alert alert-danger d-none">
                                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Überschneidung erkannt!</h6>
                                    <p class="mb-2">Der neue Zeitraum überschneidet sich mit:</p>
                                    <ul id="ueberschneidende-zeitraeume"></ul>
                                    <p class="mb-0"><strong>Pro Tag ist nur ein Zeitraum erlaubt.</strong></p>
                                </div>

                                @if (!Model.Zeitraeume.Any())
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Keine Zeiträume definiert.</strong>
                                        Fügen Sie Zeiträume hinzu oder lassen Sie leer für automatische Generierung bis zum Ende der Umschulung.
                                    </div>
                                }
                                else
                                {
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-graph-up me-1"></i>
                                            Praktikum: @Model.Zeitraeume.Count(z => z.Kategorie == "Praktikum") •
                                            Umschulung: @Model.Zeitraeume.Count(z => z.Kategorie == "Umschulung") •
                                            Gesamt: @Model.Zeitraeume.Sum(z => z.AnzahlTage) Tage
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- GENERATE-BUTTON -->
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-success btn-lg px-5" id="generate-button"
                                    onclick="document.getElementById('wochennachweis-form').submit();">
                                <i class="bi bi-file-earmark-word me-2"></i>
                                Wochennachweise generieren
                                <br><small class="fw-normal">Client-seitige Erstellung mit ZIP-Unterordnern</small>
                            </button>

                            @if (debugEnabled)
                            {
                                <button type="button" class="btn btn-outline-secondary ms-2" id="test-docxtemplater-button">
                                    <i class="bi bi-wrench me-1"></i>Docxtemplater testen
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>

            <!-- INFO-KARTEN -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Tipps</h6>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li>Definieren Sie alle Zeiträume von Beginn bis Ende</li>
                                <li>Feiertage werden automatisch erkannt</li>
                                <li>ZIP-Download enthält Praktikum/- und Umschulung/-Ordner</li>
                                <li>Überschneidungen werden automatisch erkannt</li>
                                <li>Enter-Taste zum schnellen Hinzufügen</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4 border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-question-circle me-2"></i>Hilfe</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a asp-action="Help" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-book me-1"></i>Ausführliche Anleitung
                                </a>
                                <a asp-action="TemplateHelp" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-file-earmark-word me-1"></i>Template-Platzhalter
                                </a>
                                @if (debugEnabled)
                                {
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="debugDOMElements()">
                                        <i class="bi bi-bug me-1"></i>Debug DOM
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // GLOBALE VARIABLEN
        var DEBUG_ENABLED = @(debugEnabled.ToString().ToLower());
        var ZEITRAEUME_COUNT = @Model.Zeitraeume.Count;

        // DOM READY EVENT
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 INDEX.CSHTML geladen');
            initializeTooltips();
            initializeFormValidation();
            initializeSignaturUpload();
            initializeInlineZeitraumEingabe();
        });

        // INLINE ZEITRAUM-EINGABE
        function initializeInlineZeitraumEingabe() {
            const heute = new Date().toISOString().split('T')[0];
            const startInput = document.getElementById('neues-start');
            const endeInput = document.getElementById('neues-ende');

            if (startInput && !startInput.value) {
                startInput.value = heute;
            }

            if (endeInput && !endeInput.value && startInput) {
                const startDate = new Date(startInput.value || heute);
                startDate.setDate(startDate.getDate() + 6);
                endeInput.value = startDate.toISOString().split('T')[0];
            }

            // Event-Listener
            if (startInput) {
                startInput.addEventListener('change', function() {
                    if (endeInput && (!endeInput.value || new Date(endeInput.value) <= new Date(this.value))) {
                        const newEndDate = new Date(this.value);
                        newEndDate.setDate(newEndDate.getDate() + 6);
                        endeInput.value = newEndDate.toISOString().split('T')[0];
                    }
                });
            }

            // Enter-Taste Handler
            ['neue-kategorie', 'neues-start', 'neues-ende', 'neue-beschreibung'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addZeitraumInline();
                        }
                    });
                }
            });
        }

        async function addZeitraumInline() {
            const kategorie = document.getElementById('neue-kategorie').value;
            const start = document.getElementById('neues-start').value;
            const ende = document.getElementById('neues-ende').value;
            const beschreibung = document.getElementById('neue-beschreibung').value;

            // Validierung
            if (!kategorie || !start || !ende || !beschreibung) {
                showAlert('Bitte alle Felder ausfüllen!', 'warning');
                return;
            }

            if (new Date(ende) <= new Date(start)) {
                showAlert('Das Enddatum muss nach dem Startdatum liegen!', 'warning');
                return;
            }

            const btn = document.getElementById('hinzufuegen-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Prüfe...';

            try {
                // Überschneidung prüfen
                const overlap = await checkUeberschneidung({ kategorie, start, ende, beschreibung });

                if (overlap.hasOverlap) {
                    showUeberschneidungsWarnung(overlap.overlappingPeriods);
                    return;
                }

                // Zeitraum hinzufügen
                const formData = new FormData();
                formData.append('NeuerZeitraum.Kategorie', kategorie);
                formData.append('NeuerZeitraum.Start', start);
                formData.append('NeuerZeitraum.Ende', ende);
                formData.append('NeuerZeitraum.Beschreibung', beschreibung);

                // Grunddaten mitschicken
                formData.append('Nachname', document.getElementById('Nachname').value || '');
                formData.append('Vorname', document.getElementById('Vorname').value || '');
                formData.append('Klasse', document.getElementById('Klasse').value || '');
                formData.append('Bundesland', document.getElementById('Bundesland').value || '');
                formData.append('Umschulungsbeginn', document.getElementById('Umschulungsbeginn').value || '');
                formData.append('UmschulungsEnde', document.getElementById('UmschulungsEnde').value || '');

                const response = await fetch('/Home/AddZeitraumInline', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showAlert(result.message, 'danger');
                }

            } catch (error) {
                console.error('❌ Fehler beim Hinzufügen:', error);
                showAlert('Fehler: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function checkUeberschneidung(zeitraum) {
            try {
                const response = await fetch('/Home/CheckUeberschneidung', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(zeitraum)
                });
                return await response.json();
            } catch (error) {
                console.error('❌ Überschneidungsprüfung Fehler:', error);
                return { hasOverlap: false };
            }
        }

        function showUeberschneidungsWarnung(overlappingPeriods) {
            const warnDiv = document.getElementById('ueberschneidungs-warnung');
            const listDiv = document.getElementById('ueberschneidende-zeitraeume');

            if (warnDiv && listDiv) {
                listDiv.innerHTML = overlappingPeriods.map(period => `<li>${period}</li>`).join('');
                warnDiv.classList.remove('d-none');
                setTimeout(() => warnDiv.classList.add('d-none'), 10000);
            }
        }

        // DELETE FUNCTION
        function deleteZeitraum(index) {
            if (confirm('Zeitraum wirklich löschen?')) {
                const form = document.getElementById('delete-form-' + index);
                if (form) {
                    form.submit();
                } else {
                    // Fallback
                    const fallbackForm = document.createElement('form');
                    fallbackForm.method = 'POST';
                    fallbackForm.action = '/Home/DeleteZeitraum';
                    const indexInput = document.createElement('input');
                    indexInput.type = 'hidden';
                    indexInput.name = 'index';
                    indexInput.value = index;
                    fallbackForm.appendChild(indexInput);
                    document.body.appendChild(fallbackForm);
                    fallbackForm.submit();
                }
            }
        }

        // SIGNATUR-UPLOAD
        function initializeSignaturUpload() {
            const uploadInput = document.getElementById('signatur-upload');
            if (uploadInput) {
                uploadInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('signaturFile', file);

                    try {
                        const response = await fetch('/Home/UploadSignatur', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            showAlert(result.message, 'success');
                        } else {
                            showAlert(result.message, 'danger');
                            uploadInput.value = '';
                        }
                    } catch (error) {
                        console.error('❌ Upload-Fehler:', error);
                        showAlert('Upload fehlgeschlagen: ' + error.message, 'danger');
                        uploadInput.value = '';
                    }
                });
            }
        }

        // RESET-FUNKTION
        function resetAll() {
            if (confirm('Wirklich alle Daten zurücksetzen?')) {
                if (typeof sessionStorage !== 'undefined') sessionStorage.clear();
                if (typeof localStorage !== 'undefined') localStorage.clear();

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Home/Reset';
                document.body.appendChild(form);
                form.submit();
            }
        }

        // HILFSFUNKTIONEN
        function initializeTooltips() {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl, { html: true });
            });
        }

        function initializeFormValidation() {
            const forms = document.querySelectorAll('form');
            forms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                });
            });
        }

        function showAlert(message, type) {
            if (typeof Swal !== 'undefined') {
                const icon = type === 'success' ? 'success' : type === 'danger' ? 'error' : 'warning';
                Swal.fire({
                    icon: icon,
                    title: type === 'success' ? 'Erfolgreich!' : type === 'danger' ? 'Fehler!' : 'Hinweis',
                    text: message,
                    timer: type === 'success' ? 3000 : undefined,
                    showConfirmButton: type !== 'success'
                });
            } else {
                alert(message);
            }
        }

        // DEBUG-FUNKTIONEN (nur wenn Debug aktiv)
        @if (debugEnabled)
        {
                <text>
                function debugDOMElements() {
                    console.log('🔍 DOM DEBUG REPORT:');
                    console.log('=====================================');

                    console.log('📋 Alle Forms:');
                    document.querySelectorAll('form').forEach(function(form, i) {
                        console.log('  ' + (i+1) + ': {id: "' + form.id + '", action: "' + form.action + '", method: "' + form.method + '"}');
                    });

                    console.log('📋 Delete-Forms:');
                    var deleteForms = document.querySelectorAll('.delete-zeitraum-form');
                    console.log('  Delete-Forms gefunden: ' + deleteForms.length);
                    deleteForms.forEach(function(form, i) {
                        console.log('  Form ' + (i+1) + ': {id: "' + form.id + '", action: "' + form.action + '"}');
                    });

                    console.log('📋 Zeiträume-Tabelle:');
                    var table = document.getElementById('zeitraeume-table');
                    console.log('  Tabelle vorhanden: ' + !!table);
                    if (table) {
                        var rows = table.querySelectorAll('tbody tr');
                        console.log('  Zeilen in tbody: ' + rows.length);
                    }

                    console.log('📋 Eingabe-Felder:');
                    ['neue-kategorie', 'neues-start', 'neues-ende', 'neue-beschreibung'].forEach(id => {
                        var el = document.getElementById(id);
                        console.log('  ' + id + ': ' + (el ? '✅ Gefunden' : '❌ Nicht gefunden'));
                    });

                    console.log('=====================================');
                }

                console.log('🔧 INDEX.CSHTML DEBUG AKTIV');
                console.log('🔧 Debug-Funktionen verfügbar: debugDOMElements()');
                </text>
        }

        console.log('📋 Index-Page JavaScript geladen');
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}